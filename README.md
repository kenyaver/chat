# client-server chat application

разработка терминального клиент-серверного приложения для обмена текстовыми сообщениями попарно между ограниченной группой лиц.
при запуске клиента выбирается партнер. можно запустить несколько клиентов с разными партнерами.
каждая сессия сессия несет уникальный username. одновременно под одним именем может существовать только 1 процесс.
возможность отправки сообщений не должна зависеть от статуса партнера. количество отправляемых сообщений: не более 4 непринятых партнером.
размер сообщения не более 1024 байт, если сообщение более 1024, то оно не передается. непринятые сообщения сохраняются на сервере
    и выдаются получателю при подключении.
буффер неподтвержденных сообщений 4096 байт.
если пользователь не отправляет сообщений в течении 3 минут, то сервер отправляет клиенту предупреждение
    если пользователь не отправляет сообщений в течении 5 минут, то сервер отключает пользователя.

пояснения:
username - 1 слово, состоящее из 8 ангийских букв и цифр
<> - сообщение, набранное клиентом (пользовательское)
[] - сообщение, скрытое от пользователей (системное)
() - ссылка на пункт

Протокол взаимодействия клиента и сервера:
1. соединение происходит по протоколу TCP

2. первое сообщение клиента серверу отправляются без форматирований. <username> <partner>

3. обычные сообщения: 
    формат: [id message](4) <message>.
        клиент присылает серверу [id message] <message>.
        Сервер записывает сообщение в буффер неподтвержденных сообщений и отправляет это сообщение клиенту-получателю
        [id message](4) и <message> разделяются пробелом => клиент-получатель будет выводить полученную строку после первого пробела.
    сервер возвращает клиенту-отправителю сообщение [id message](4) <error-status>(5).
    
4. id message:
    является целым положительным числом. Используется для возможности отслеживания ошибок переправки сообщений.

5. error-status:
    200 - сообщение доставлено и прочитано (прочитанным сообщением счиитается сообщение, на идентификатор которого ответил 
        клиент-получатель серверу в формате [id message])
    300 - сообщение доставлено, но не прочитанно (клиент-получатель не ответил серверу). в таком случае сообщение записывается в файл <partner>.txt
        в формате <username: message>.
    301 - буффер переполнен, поток общения с данным пользователем завершается. отправляется после 4 отправленного и непрочитанного сообщения

6. message:
    сообщение клиента должно составлять не более 1024 байт на английском или русском языке.
        сообщение на русском языке не должно превышать 512 символов русского языка
        сообщение на английском языке не должно превышать 1024 символов английского языка
    символ '~' в сообщении сигнализирует о звершеннии сессии общения

7. завершение сессии общения:
    если завершение сессии происходит по инициативе 1 из клиентов, то последнее сообщение отправляется 
        вместе с уведомлением о завершении общения "the end session" и пользователи возвращаются в меню
    если завершение сессии происходит по инициативе сервера, то сервер отправляет сообщение клиентам "server died=(". пользователи возвращаются в меню

Сервер:
0. запуск с параметрами (порт).

1. сервер начинает слушать порт.

2. сервер получает событие подключения клиента.

3. сервер получает username пользователя и никнейм клиента-получателя.
    4.1. проверяет никнейм клиента-получателя на доступность собеседника(онлайн).
    если username занят, то сервер отправляет сообщение "choose other username". иначе сообщения не будет не будет.
    сервер уведомляет клиента-отправителя о состоянии клиента-получателя

4. если клиент-получатель онлайн, то сервер создает поток общения и переводит тудв клиентов.
    если клиент-получатель оффлайн, то все полученные сообщения записывает в файл в пределах установленных выше лимитов.

5. сервер получает сообщение:
    5.1. записывает в буффер неподтвержденных сообщений, отправляет клиенту-получателю.
    5.2. ждет от клиента-получателя обратное сообщение с идентификатором сообщения [id message] в течение 15 секунд.
    5.2.1. при получении сообщения от клиента-получателя, сервер возвращает клиенту-отправителю [id message]<error-status>.
    5.2.2. при отсутствии ответа в течение указанного времени, сервер закрывает неактивную сессию, записывает полученное сообщение в файл
        и возвращает клиенту-отправителю [id message]<error-status>.

6. повторяются шаги 5 и 6 до завершения работы (4, 5).

7. при получении '~' в сообщении клиента, сервер завершает сессию общения, клиенты возвращаются в исходное состояние выбора собеседника

8. при получении сигнала завершения работы сервера, сервер записывает все обрабатываемые сообщения из буффера сообщений в формате <username: message>,
    завершает все сессии с сообщением "server died=(".



Клиент:
0. запуск с указанием адрес порт сервера + никнейм + никнейм партнера

1. подключение к серверу

3. передача серверу своего username и username собеседника.

4. отправка сообщений с проверкой на превышение лимитов сообщения.
    5.1. если лимит не превышен, то клиент отправляет серверу <message>
    5.2. если лимит превышен, то клиент получает ошибку, сообщение не отправляется.

5. при получении сообщения, клиент отвечает серверу [id message].

6. повторяются шаги 4 и 5 до завершения работы

7. для завершения сессии общения, отправляется символ '~'
