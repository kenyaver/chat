# client-server chat application

разработка терминального клиент-серверного приложения для обмена текстовыми сообщениями попарно между ограниченной группой лиц.
при запуске клиента выбирается партнер. можно запустить несколько клиентов с разными партнерами.
каждая сессия несет username - уникальное имя.
возможность отправки сообщений не должна зависеть от статуса партнера. количество отправляемых сообщений: не более 4 непринятых партнером.
размер сообщения не более 1024 байт, если сообщение более 1024, то оно не передается. непринятые сообщения сохраняются на сервере
    и выдаются получателю при подключении.
буффер неподтвержденных сообщений 4096 байт.
если пользователь не отправляет сообщений в течении 3 минут, то сервер отправляет клиенту предупреждение
    если пользователь не отправляет сообщений в течении 5 минут, то сервер отключает пользователя.

Статус партнера - состояние искомого собеседника (подключен к серверу ил не подключен)

неподтвержденные сообщения - сообщения, переправленные сервером клиенту-получателю, но на которые сервер не получил ответ-подтверждение [id message],
    равный отправленному
непринятые сообщения - сообщения, записанные в файл

условные обозначения:
username - псевдоним клиентаю. состоит из 1 слова, состоящего из 8 ангийских букв и цифр
<> - пользовательское сообщение (видит пользователь)
[] - сообщение, скрытое от пользователей (системное)
() - ссылка на пункт

Протокол взаимодействия клиента и сервера:
1. соединение происходит по протоколу TCP

2. первое сообщение клиента серверу отправляются без форматирований. <username partner>\n . Это сообщение не нумеруется, не записывается в буффер
    и нигде не сохраняется.
    данную команду отправляет клиент. команда должна быть первой в сессии

3. команда отправки сообщения клиенту-получателю онлайн: 
    формат:
        [id message](4) <message>
    Конец <message> объявляется переводом каретки (0x0A из ASCII таблицы).
    отправляются клиентом серверу и сервером клиенту-получателю.
    клиент-отправитель ожидает получить ответ на свое сообщение.

3.1 команда отправки сообщения клиенту-получателю оффлайн:
    формат:
        <client-username: message>
        команда записывается в файл <partner>.txt и выводится клиенту-получателю, когда тот подключается к серверу.
        для данных комманд не требуется подтверждение. сервер просто отправляет эти сообщения клиенту-получателю, когда тот подключается к серверу

4. ответ:
    клиент отправляет команду серверу:
        [id message] <message>
    Сервер записывает этот <message> в буффер неподтвержденных команд и отправляет его клиенту-получателю
    клиент-получатель отправляет серверу ответ-подтверждение ([id message]).
    сервер удаляет команду из буффера неподтвержденных команд
    сервер возвращает клиенту-отправителю сообщение <id message: status>(5).
    [id message](4) и <message> разделяются пробелом => клиент-получатель будет выводить полученную строку после первого пробела.
    
    
5. message id:
    является целым положительным числом. Используется для возможности идентифиации сообщений.
    Изначально равен 0 и прибавляется по 1 при каждом отправлении <message> клиента серверу. является строкой в десятичной записи числа от 0 до 65 535
    уникален для клиента-отправителя.

6. status:
    200 - сообщение доставлено и прочитано (прочитанным сообщением счиитается сообщение, на идентификатор которого ответил 
        клиент-получатель серверу в формате [id message])
    300 - сообщение доставлено, но не прочитанно (клиент-получатель не ответил серверу). в таком случае сообщение записывается сервером в файл <partner>.txt
        в формате <username: message>.
    301 - буффер переполнен, поток общения с данным пользователем завершается. 
        отправляется после 4 отправленного и непрочитанного сообщения (клиент-получатель оффлайн)

7. message:
    сообщение клиента должно составлять не более 1024 байт на английском или русском языке.
        сообщение на русском языке не должно превышать 512 символов русского языка
        сообщение на английском языке не должно превышать 1024 символов английского языка
    символ '~' в любом месте message сигнализирует о звершеннии сессии общения

8. завершение сессии общения:
    если завершение сессии происходит по инициативе 1 из клиентов, то последнее сообщение отправляется клиенту-получателю.
        После этого сервер отправляет уведомление клиенту-получателю о завершении общения "the end session" и программа завершается
    если завершение сессии происходит по инициативе сервера, то сервер отправляет сообщение клиентам "server died=(". пользователи возвращаются в меню

Сервер:
0. запуск с параметрами (порт).

1. сервер начинает слушать порт.

2. сервер получает событие подключения клиента.

3. сервер получает username пользователя и никнейм клиента-получателя.
    4.1. проверяет никнейм клиента-получателя на доступность собеседника(онлайн).
    если username занят, то сервер отправляет сообщение "choose other username". иначе сообщения не будет не будет.
    сервер уведомляет клиента-отправителя о состоянии клиента-получателя

4. если клиент-получатель онлайн, то сервер создает поток общения и переводит тудв клиентов.
    если клиент-получатель оффлайн, то все полученные сообщения записывает в файл в пределах установленных выше лимитов.

5. сервер получает сообщение:
    5.1. записывает в буффер неподтвержденных сообщений, отправляет клиенту-получателю.
    5.2. ждет от клиента-получателя обратное сообщение с идентификатором сообщения [id message] в течение 15 секунд.
    5.2.1. при получении сообщения от клиента-получателя, сервер возвращает клиенту-отправителю [id message]<status>.
    5.2.2. при отсутствии ответа в течение указанного времени, сервер закрывает неактивную сессию, записывает полученное сообщение в файл
        и возвращает клиенту-отправителю [id message]<status>.

6. повторяется шаг 5 до завершения работы.

7. при получении '~' в сообщении (в любом месте) клиента, сервер завершает сессию общения, клиенты возвращаются в исходное состояние выбора собеседника

8. при получении сигнала завершения работы сервера, сервер записывает в файл все обрабатываемые сообщения из буффера сообщений в формате <username: message>,
    завершает все сессии с сообщением "server died=(".



Клиент:
0. запуск с указанием адрес порт сервера + никнейм + никнейм партнера

1. подключение к серверу

3. передача серверу своего username и username собеседника.

4. ожидается любое из событий (5 или 6)

5. отправка сообщений с проверкой на превышение лимитов сообщения.
    5.1. если лимит не превышен, то клиент отправляет серверу <message>
    5.2. если лимит превышен, то клиент получает ошибку, сообщение не отправляется.

6. при получении сообщения, клиент отвечает серверу [id message].

7. повторяются шаг 4 до завершения работы

8. для завершения сессии общения, отправляется символ '~' в любом месте <message>
